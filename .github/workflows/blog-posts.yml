name: Update Latest Blog Posts

on:
  repository_dispatch:
    types: [blog-updated]
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Update blog posts in README
        uses: gautamkrishnar/blog-post-workflow@6a6e64abd1f651445da8e59611d0ca0110979aa5 # v1.9.4
        with:
          gh_token: ${{ secrets.PAT_TOKEN }}
          feed_list: "https://haydenk.github.io/feed.xml"
          max_post_count: 10
          template: "<tr><td>$date</td><td><a href=\"$url\">$title</a></td></tr>"
          date_format: "yyyy-mm-dd"
          comment_tag_name: "BLOG-POST-LIST"
          skip_commit: true

      - name: Commit README via Contents API
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          if git diff --quiet README.md; then
            echo "No changes to README.md, skipping."
            exit 0
          fi
          CONTENT=$(base64 -w 0 README.md)
          SHA=$(gh api repos/haydenk/haydenk/contents/README.md --jq '.sha')
          gh api --method PUT repos/haydenk/haydenk/contents/README.md \
            -f message="Update latest blog posts in README" \
            -f content="$CONTENT" \
            -f sha="$SHA"
